<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись на занятие</title>
</head>
<body>
    <h1>Запись на занятие</h1>

    <!-- Шаг 1: Выбор класса -->
    <div id="step1">
        <h2>Шаг 1: Выберите ваш класс</h2>
        <select id="classSelect" onchange="showSubjects()">
            <option value="">-- Выберите класс --</option>
            {{range .Grades}}
            <option value="{{.ID}}">{{.GradeName}}</option>
            {{end}}
        </select>
    </div>

    <!-- Шаг 2: Выбор предмета -->
    <div id="step2" style="display:none">
        <h2>Шаг 2: Выберите предмет</h2>
        <select id="subjectSelect" onchange="showTeachers()">
            <option value="">-- Выберите предмет --</option>
            {{range .Subjects}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
    </div>

    <!-- Шаг 3: Выбор преподавателя -->
    <div id="step3" style="display:none">
        <h2>Шаг 3: Выберите преподавателя</h2>
        <div id="teachersList"></div>
    </div>

    <!-- Шаг 4: Контактные данные -->
    <div id="step4" style="display:none">
        <h2>Шаг 4: Ваши контактные данные</h2>
        
        <h3>Имя:</h3>
        <input type="text" id="studentName">
        
        <h3>Телефон:</h3>
        <input type="tel" id="studentPhone">
        
        <h3>Email:</h3>
        <input type="email" id="studentEmail">
        
        <input type="hidden" id="selectedTutorId">
        <input type="hidden" id="selectedSlotId"> <br><br>
        <button onclick="submitApplication()">Завершить запись</button>
    </div>

    <br>
    <a href="/">
        <button>Вернуться на главную</button>
    </a>

    <script>
        let selectedTutor = null;

        function showSubjects() {
            const classSelect = document.getElementById('classSelect');
            const step2 = document.getElementById('step2');
            
            if (classSelect.value) {
                // Показываем шаг 2
                step2.style.display = 'block';
                // Сбрасываем следующие шаги
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'none';
            }
        }

        function showTeachers() {
            const classSelect = document.getElementById('classSelect');
            const subjectSelect = document.getElementById('subjectSelect');
            const teachersList = document.getElementById('teachersList');
            const step3 = document.getElementById('step3');
            
            if (subjectSelect.value && classSelect.value) {
                teachersList.innerHTML = '<p>Загрузка преподавателей...</p>';
                
                // Отправляем запрос к API для получения преподавателей
                fetch('/api/tutors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `subject_id=${subjectSelect.value}&grade_id=${classSelect.value}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayTeachers(data.tutors);
                    } else {
                        teachersList.innerHTML = '<p>Ошибка при загрузке преподавателей</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    teachersList.innerHTML = '<p>Ошибка при загрузке преподавателей</p>';
                });
                
                // Показываем шаг 3
                step3.style.display = 'block';
            }
        }

        function displayTeachers(tutors) {
            const teachersList = document.getElementById('teachersList');
            
            if (!tutors || tutors.length === 0) {
                teachersList.innerHTML = '<p>На данный момент нет доступных преподавателей по этому предмету</p>';
                return;
            }
            
            teachersList.innerHTML = '';
            
            tutors.forEach(tutor => {
                const teacherDiv = document.createElement('div');
                teacherDiv.className = 'teacher-card'; // Добавим класс для стилей
                teacherDiv.style.border = '1px solid #ccc';
                teacherDiv.style.padding = '10px';
                teacherDiv.style.margin = '10px 0';

                // Формируем кнопки для каждого свободного слота
                let slotsHtml = '';
                if (tutor.time_slots && tutor.time_slots.length > 0) {
                    slotsHtml = tutor.time_slots.map(slot => {
                        const date = new Date(slot.date).toLocaleDateString('ru-RU');
                        // При нажатии на время вызываем selectSlot
                        return `<button class="slot-btn" onclick="selectSlot(${tutor.id}, ${slot.id}, '${tutor.full_name}', '${date} ${slot.start_time}')">
                                    ${date} ${slot.start_time}
                                </button>`;
                    }).join(' ');
                } else {
                    slotsHtml = '<span style="color:red">Нет свободных окон</span>';
                }

                teacherDiv.innerHTML = `
                    <h3>${tutor.full_name}</h3>
                    <p><strong>Опыт:</strong> ${tutor.experience_years} лет | <strong>Цена:</strong> ${tutor.hourly_rate} руб/час</p>
                    <p><strong>Выберите время для занятия:</strong></p>
                    <div class="slots-container">${slotsHtml}</div>
                `;
                teachersList.appendChild(teacherDiv);
            });
        }

        function selectTeacher(tutorId, tutorName) {
            selectedTutor = { id: tutorId, name: tutorName };
            document.getElementById('selectedTutorId').value = tutorId;
            alert(`Вы выбрали: ${tutorName}`);
            
            // Показываем шаг 4
            document.getElementById('step4').style.display = 'block';
        }
        


        function selectSlot(tutorId, slotId, tutorName, slotTime) {
            console.log("Выбран репетитор:", tutorId, "Слот:", slotId); // Для проверки в консоли браузера (F12)

            // 1. Записываем данные в скрытые поля
            document.getElementById('selectedTutorId').value = tutorId;
            document.getElementById('selectedSlotId').value = slotId;

            // 2. Показываем визуальное подтверждение
            alert(`Вы выбрали: ${tutorName}\nВремя: ${slotTime}`);

            // 3. Делаем видимым Шаг 4
            const step4 = document.getElementById('step4');
            step4.style.display = 'block';

            // 4. Прокручиваем страницу вниз к форме
            step4.scrollIntoView({ behavior: 'smooth' });
        }
        function submitApplication() {
            const name = document.getElementById('studentName').value;
            const phone = document.getElementById('studentPhone').value;
            const email = document.getElementById('studentEmail').value;
            const tutorId = document.getElementById('selectedTutorId').value;
            const slotId = document.getElementById('selectedSlotId').value;

            // ЛОГИ ДЛЯ ПРОВЕРКИ (Нажмите F12 в браузере, чтобы увидеть)
            console.log("Данные перед отправкой:", { name, phone, email, tutorId, slotId });

            if (name && phone && email && tutorId && slotId) {
                fetch('/api/application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `tutor_id=${tutorId}&slot_id=${slotId}&student_name=${encodeURIComponent(name)}&student_phone=${encodeURIComponent(phone)}&student_email=${encodeURIComponent(email)}`
                })
                .then(response => {
                    console.log("Статус ответа сервера:", response.status);
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        alert('Вы успешно записаны!');
                        window.location.href = '/';
                    } else {
                        alert('Ошибка сервера: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error("Ошибка Fetch:", err);
                    alert('Не удалось связаться с сервером');
                });
            } else {
                // Уточняем, чего именно не хватает
                let missing = [];
                if(!name) missing.push("Имя");
                if(!phone) missing.push("Телефон");
                if(!email) missing.push("Email");
                if(!tutorId) missing.push("ID репетитора");
                if(!slotId) missing.push("Время (слот)");
                
                alert('Заполните поля: ' + missing.join(", "));
            }
        }

        function resetForm() {
            document.getElementById('classSelect').value = '';
            document.getElementById('subjectSelect').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('selectedTutorId').value = '';
            
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').style.display = 'none';
            
            selectedTutor = null;
        }
    </script>
</body>
</html>