<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись на занятие</title>
</head>
<body>
    <h1>Запись на занятие</h1>

    <!-- Шаг 1: Выбор класса -->
    <div id="step1">
        <h2>Шаг 1: Выберите ваш класс</h2>
        <select id="classSelect" onchange="showSubjects()">
            <option value="">-- Выберите класс --</option>
            {{range .Grades}}
            <option value="{{.ID}}">{{.GradeName}}</option>
            {{end}}
        </select>
    </div>

    <!-- Шаг 2: Выбор предмета -->
    <div id="step2" style="display:none">
        <h2>Шаг 2: Выберите предмет</h2>
        <select id="subjectSelect" onchange="showTeachers()">
            <option value="">-- Выберите предмет --</option>
            {{range .Subjects}}
            <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>
    </div>

    <!-- Шаг 3: Выбор преподавателя -->
    <div id="step3" style="display:none">
        <h2>Шаг 3: Выберите преподавателя</h2>
        <div id="teachersList"></div>
    </div>

    <!-- Шаг 4: Контактные данные -->
    <div id="step4" style="display:none">
        <h2>Шаг 4: Ваши контактные данные</h2>
        
        <h3>Имя:</h3>
        <input type="text" id="studentName">
        
        <h3>Телефон:</h3>
        <input type="tel" id="studentPhone">
        
        <h3>Email:</h3>
        <input type="email" id="studentEmail">
        
        <input type="hidden" id="selectedTutorId">
        
        <br><br>
        <button onclick="submitApplication()">Завершить запись</button>
    </div>

    <br>
    <a href="/">
        <button>Вернуться на главную</button>
    </a>

    <script>
        let selectedTutor = null;

        function showSubjects() {
            const classSelect = document.getElementById('classSelect');
            const step2 = document.getElementById('step2');
            
            if (classSelect.value) {
                // Показываем шаг 2
                step2.style.display = 'block';
                // Сбрасываем следующие шаги
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'none';
            }
        }

        function showTeachers() {
            const classSelect = document.getElementById('classSelect');
            const subjectSelect = document.getElementById('subjectSelect');
            const teachersList = document.getElementById('teachersList');
            const step3 = document.getElementById('step3');
            
            if (subjectSelect.value && classSelect.value) {
                teachersList.innerHTML = '<p>Загрузка преподавателей...</p>';
                
                // Отправляем запрос к API для получения преподавателей
                fetch('/api/tutors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `subject_id=${subjectSelect.value}&grade_id=${classSelect.value}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayTeachers(data.tutors);
                    } else {
                        teachersList.innerHTML = '<p>Ошибка при загрузке преподавателей</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    teachersList.innerHTML = '<p>Ошибка при загрузке преподавателей</p>';
                });
                
                // Показываем шаг 3
                step3.style.display = 'block';
            }
        }

        function displayTeachers(tutors) {
            const teachersList = document.getElementById('teachersList');
            
            if (!tutors || tutors.length === 0) {
                teachersList.innerHTML = '<p>На данный момент нет доступных преподавателей по этому предмету</p>';
                return;
            }
            
            teachersList.innerHTML = '';
            
            tutors.forEach(tutor => {
                const teacherDiv = document.createElement('div');
                teacherDiv.style.border = '1px solid #ccc';
                teacherDiv.style.padding = '10px';
                teacherDiv.style.margin = '10px 0';
                
                // Форматируем стоимость
                const hourlyRate = tutor.hourly_rate ? `${tutor.hourly_rate} руб/час` : 'Не указана';
                
                // Форматируем расписание
                let scheduleInfo = 'Нет доступных окон';
                if (tutor.time_slots && tutor.time_slots.length > 0) {
                    const slots = tutor.time_slots.map(slot => {
                        const date = new Date(slot.date).toLocaleDateString('ru-RU');
                        return `${date} ${slot.start_time}-${slot.end_time}`;
                    });
                    scheduleInfo = slots.join(', ');
                }
                
                teacherDiv.innerHTML = `
                    <h3>${tutor.full_name}</h3>
                    <p><strong>Опыт работы:</strong> ${tutor.experience_years} лет</p>
                    <p><strong>Стоимость:</strong> ${hourlyRate}</p>
                    <p><strong>Рейтинг:</strong> ${tutor.avg_rating ? tutor.avg_rating.toFixed(1) : 'Нет оценок'}</p>
                    <p><strong>Биография:</strong> ${tutor.bio || 'Не указана'}</p>
                    <p><strong>Доступные окна:</strong> ${scheduleInfo}</p>
                    <button onclick="selectTeacher(${tutor.id}, '${tutor.full_name.replace(/'/g, "\\'")}')">Выбрать этого преподавателя</button>
                `;
                
                teachersList.appendChild(teacherDiv);
            });
        }

        function selectTeacher(tutorId, tutorName) {
            selectedTutor = { id: tutorId, name: tutorName };
            document.getElementById('selectedTutorId').value = tutorId;
            alert(`Вы выбрали: ${tutorName}`);
            
            // Показываем шаг 4
            document.getElementById('step4').style.display = 'block';
        }

        function submitApplication() {
            const name = document.getElementById('studentName').value;
            const phone = document.getElementById('studentPhone').value;
            const email = document.getElementById('studentEmail').value;
            const tutorId = document.getElementById('selectedTutorId').value;
            
            if (name && phone && email && tutorId) {
                // Отправляем заявку на сервер
                fetch('/api/application', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `tutor_id=${tutorId}&student_name=${encodeURIComponent(name)}&student_phone=${encodeURIComponent(phone)}&student_email=${encodeURIComponent(email)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Заявка отправлена! Мы свяжемся с вами в ближайшее время.');
                        // Сбрасываем форму
                        resetForm();
                    } else {
                        alert('Ошибка при отправке заявки: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка при отправке заявки');
                });
            } else {
                alert('Пожалуйста, заполните все контактные данные');
            }
        }

        function resetForm() {
            document.getElementById('classSelect').value = '';
            document.getElementById('subjectSelect').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('selectedTutorId').value = '';
            
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').style.display = 'none';
            
            selectedTutor = null;
        }
    </script>
</body>
</html>