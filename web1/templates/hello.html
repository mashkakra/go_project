<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Запись на занятие</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f7f6f2;
            --surface: #ffffff;
            --text: #1e1f22;
            --muted: #6b6f76;
            --accent: #5aa9e6;
            --accent-dark: #4b92c9;
            --border: #ece6dc;
            --shadow: 0 12px 30px rgba(25, 25, 25, 0.08);
            --glow: 0 12px 26px rgba(90, 169, 230, 0.35);
            --radius-lg: 18px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
            color: var(--text);
            background: var(--bg);
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: min(1120px, 92vw);
            margin: 0 auto;
        }

        .site-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .site-header__inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }

        .brand__badge {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--accent);
            display: grid;
            place-items: center;
            font-weight: 700;
            color: #1a1a1a;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            border: 0;
            border-radius: 999px;
            padding: 10px 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: #1a1a1a;
            box-shadow: var(--glow);
        }

        .btn-primary:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .hero {
            padding: 36px 0 24px;
        }

        .hero-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow);
            display: grid;
            gap: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hero-card h1 {
            margin: 0;
            font-size: clamp(28px, 3vw, 40px);
        }

        .hero-card p {
            margin: 0;
            color: var(--muted);
            font-size: 16px;
        }

        .steps {
            display: grid;
            gap: 18px;
            padding-bottom: 40px;
        }

        .step-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 36px rgba(25, 25, 25, 0.12);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .step-badge {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(242, 178, 51, 0.2);
            color: #a36b00;
            display: grid;
            place-items: center;
            font-weight: 700;
        }

        .form-row {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        select,
        input {
            width: 100%;
            padding: 12px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 15px;
            background: #fff;
        }

        label {
            font-size: 13px;
            color: var(--muted);
        }

        .teachers-grid {
            display: grid;
            gap: 16px;
        }

        .teacher-card {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            background: #fffdf7;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .teacher-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(25, 25, 25, 0.12);
        }

        .teacher-card h3 {
            margin: 0 0 8px;
        }

        .slots-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .slot-btn {
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .slot-btn:hover {
            border-color: var(--accent);
            color: #1a1a1a;
            background: rgba(242, 178, 51, 0.15);
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
        }

        .footer-note {
            text-align: center;
            color: var(--muted);
            padding: 24px 0 40px;
        }

        @media (max-width: 720px) {
            .site-header__inner {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .hero-card {
                padding: 24px;
            }

            .step-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="site-header">
            <div class="container site-header__inner">
                <div class="brand">
                    <div class="brand__badge">T</div>
                    <span>Тринити</span>
                </div>
                <div class="header-actions">
                    <a class="btn btn-ghost" href="/">На главную</a>
                    <a class="btn btn-primary" href="#step1">Начать запись</a>
                </div>
            </div>
        </header>

        <main>
            <section class="hero">
                <div class="container">
                    <div class="hero-card">
                        <h1>Подберите репетитора за 4 шага</h1>
                        <p>Укажите класс и предмет, выберите преподавателя и удобное время. Мы передадим заявку в личный кабинет.</p>
                    </div>
                </div>
            </section>

            <section class="container steps">
                <!-- Шаг 1: Выбор класса -->
                <div id="step1" class="step-card">
                    <div class="step-header">
                        <div class="step-badge">1</div>
                        <div>
                            <h2>Выберите ваш класс</h2>
                            <p class="muted">Это поможет показать подходящие программы.</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="classSelect">Класс</label>
                            <select id="classSelect" onchange="showSubjects()">
                                <option value="" disabled selected>Выберите класс</option>
                                {{range .Grades}}
                                <option value="{{.ID}}">{{.GradeName}}</option>
                                {{end}}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Шаг 2: Выбор предмета -->
                <div id="step2" class="step-card" style="display:none">
                    <div class="step-header">
                        <div class="step-badge">2</div>
                        <div>
                            <h2>Выберите предмет</h2>
                            <p class="muted">Подберем репетиторов с опытом именно в этой области.</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="subjectSelect">Предмет</label>
                            <select id="subjectSelect" onchange="showTeachers()">
                                <option value="" disabled selected>Выберите предмет</option>
                                {{range .Subjects}}
                                <option value="{{.ID}}">{{.Name}}</option>
                                {{end}}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Шаг 3: Выбор преподавателя -->
                <div id="step3" class="step-card" style="display:none">
                    <div class="step-header">
                        <div class="step-badge">3</div>
                        <div>
                            <h2>Выберите преподавателя</h2>
                            <p class="muted">Доступные окна отображаются по каждому репетитору.</p>
                        </div>
                    </div>
                    <div id="teachersList" class="teachers-grid"></div>
                </div>

                <!-- Шаг 4: Контактные данные -->
                <div id="step4" class="step-card" style="display:none">
                    <div class="step-header">
                        <div class="step-badge">4</div>
                        <div>
                            <h2>Ваши контактные данные</h2>
                            <p class="muted">Мы свяжемся с вами после подтверждения.</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="studentName">Имя</label>
                            <input type="text" id="studentName" placeholder="Как к вам обращаться">
                        </div>
                        <div>
                            <label for="studentPhone">Телефон</label>
                            <input type="tel" id="studentPhone" placeholder="+7 (___) ___-__-__">
                        </div>
                        <div>
                            <label for="studentEmail">Email</label>
                            <input type="email" id="studentEmail" placeholder="you@example.com">
                        </div>
                    </div>
                    <input type="hidden" id="selectedTutorId">
                    <input type="hidden" id="selectedSlotId">
                    <div class="actions-row">
                        <button class="btn btn-primary" onclick="submitApplication()">Завершить запись</button>
                        <a class="btn btn-ghost" href="/">Вернуться на главную</a>
                    </div>
                </div>
            </section>
        </main>

        <div class="footer-note">Если понадобится помощь, напишите нам после отправки заявки.</div>
    </div>

    <script>
        let selectedTutor = null;

        function showSubjects() {
            const classSelect = document.getElementById('classSelect');
            const step2 = document.getElementById('step2');
            
            if (classSelect.value) {
                // Показываем шаг 2
                step2.style.display = 'block';
                // Сбрасываем следующие шаги
                document.getElementById('step3').style.display = 'none';
                document.getElementById('step4').style.display = 'none';
            }
        }

        function showTeachers() {
            const classSelect = document.getElementById('classSelect');
            const subjectSelect = document.getElementById('subjectSelect');
            const teachersList = document.getElementById('teachersList');
            const step3 = document.getElementById('step3');
            
            if (subjectSelect.value && classSelect.value) {
                teachersList.innerHTML = '<p>Загрузка преподавателей...</p>';
                
                // Отправляем запрос к API для получения преподавателей
                fetch('/api/tutors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `subject_id=${subjectSelect.value}&grade_id=${classSelect.value}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayTeachers(data.tutors);
                    } else {
                        teachersList.innerHTML = '<p>Ошибка при загрузке преподавателей</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    teachersList.innerHTML = '<p>Ошибка при загрузке преподавателей</p>';
                });
                
                // Показываем шаг 3
                step3.style.display = 'block';
            }
        }

        function displayTeachers(tutors) {
            const teachersList = document.getElementById('teachersList');
            
            if (!tutors || tutors.length === 0) {
                teachersList.innerHTML = '<p>На данный момент нет доступных преподавателей по этому предмету</p>';
                return;
            }
            
            teachersList.innerHTML = '';
            
            tutors.forEach(tutor => {
                const teacherDiv = document.createElement('div');
                teacherDiv.className = 'teacher-card'; // Добавим класс для стилей

                // Формируем кнопки для каждого свободного слота
                let slotsHtml = '';
                if (tutor.time_slots && tutor.time_slots.length > 0) {
                    slotsHtml = tutor.time_slots.map(slot => {
                        const dateObj = new Date(slot.date);
                        
                        // Получаем день недели (например, "понедельник")
                        const weekday = dateObj.toLocaleDateString('ru-RU', { weekday: 'long' });
                        // Делаем первую букву заглавной
                        const weekdayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1);
                        
                        // Оставляем обычную дату для передачи в функцию selectSlot (чтобы в alert была дата)
                        const dateNumeric = dateObj.toLocaleDateString('ru-RU');

                        // В тексте кнопки теперь weekdayCapitalized вместо dateNumeric
                        return `<button class="slot-btn" onclick="selectSlot(${tutor.id}, ${slot.id}, '${tutor.full_name}', '${dateNumeric} ${slot.start_time}')">
                                    ${weekdayCapitalized}, ${slot.start_time}
                                </button>`;
                    }).join(' ');
                } else {
                    slotsHtml = '<span style="color:red">Нет свободных окон</span>';
                }

                teacherDiv.innerHTML = `
                    <h3>${tutor.full_name}</h3>
                    <p><strong>Опыт:</strong> ${tutor.experience_years} лет | <strong>Цена:</strong> ${tutor.hourly_rate} руб/час</p>
                    <p><strong>Выберите время для занятия:</strong></p>
                    <div class="slots-container">${slotsHtml}</div>
                `;
                teachersList.appendChild(teacherDiv);
            });
        }

        function selectTeacher(tutorId, tutorName) {
            selectedTutor = { id: tutorId, name: tutorName };
            document.getElementById('selectedTutorId').value = tutorId;
            alert(`Вы выбрали: ${tutorName}`);
            
            // Показываем шаг 4
            document.getElementById('step4').style.display = 'block';
        }
        


        function selectSlot(tutorId, slotId, tutorName, slotTime) {
            console.log("Выбран репетитор:", tutorId, "Слот:", slotId); // Для проверки в консоли браузера (F12)

            // 1. Записываем данные в скрытые поля
            document.getElementById('selectedTutorId').value = tutorId;
            document.getElementById('selectedSlotId').value = slotId;

            // 2. Показываем визуальное подтверждение
            alert(`Вы выбрали: ${tutorName}\nВремя: ${slotTime}`);

            // 3. Делаем видимым Шаг 4
            const step4 = document.getElementById('step4');
            step4.style.display = 'block';

            // 4. Прокручиваем страницу вниз к форме
            step4.scrollIntoView({ behavior: 'smooth' });
        }
        function submitApplication() {
            const name = document.getElementById('studentName').value;
            const phone = document.getElementById('studentPhone').value;
            const email = document.getElementById('studentEmail').value;
            const tutorId = document.getElementById('selectedTutorId').value;
            const slotId = document.getElementById('selectedSlotId').value;

            // ЛОГИ ДЛЯ ПРОВЕРКИ (Нажмите F12 в браузере, чтобы увидеть)
            console.log("Данные перед отправкой:", { name, phone, email, tutorId, slotId });

            if (name && phone && email && tutorId && slotId) {
                fetch('/api/application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `tutor_id=${tutorId}&slot_id=${slotId}&student_name=${encodeURIComponent(name)}&student_phone=${encodeURIComponent(phone)}&student_email=${encodeURIComponent(email)}`
                })
                .then(response => {
                    console.log("Статус ответа сервера:", response.status);
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        alert('Вы успешно записаны!');
                        window.location.href = '/';
                    } else {
                        alert('Ошибка сервера: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error("Ошибка Fetch:", err);
                    alert('Не удалось связаться с сервером');
                });
            } else {
                // Уточняем, чего именно не хватает
                let missing = [];
                if(!name) missing.push("Имя");
                if(!phone) missing.push("Телефон");
                if(!email) missing.push("Email");
                if(!tutorId) missing.push("ID репетитора");
                if(!slotId) missing.push("Время (слот)");
                
                alert('Заполните поля: ' + missing.join(", "));
            }
        }

        function resetForm() {
            document.getElementById('classSelect').value = '';
            document.getElementById('subjectSelect').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('selectedTutorId').value = '';
            
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').style.display = 'none';
            
            selectedTutor = null;
        }
    </script>
</body>
</html>